# .github/workflows/ci.yml
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: write

jobs:
  # Build static binaries (indexer, ultar_httpd)
  build:
    name: Build ${{ matrix.target.name }}
    runs-on: ${{ matrix.target.runner }}
    strategy:
      matrix:
        target:
          # Linux uses musl for fully static binaries
          - { name: x86_64-linux, triplet: x86_64-linux-musl, runner: ubuntu-22.04, cpu: x86_64_v3 }
          - { name: aarch64-linux, triplet: aarch64-linux-musl, runner: ubuntu-24.04-arm, cpu: neoverse_v2 }
          - { name: aarch64-macos, triplet: aarch64-macos, runner: macos-latest, cpu: apple_m1 }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build (ReleaseSafe, ${{ matrix.target.triplet }})
        run: |
          # Build CLI tools only (no Lua/dataloader needed)
          zig build cli \
            -Doptimize=ReleaseSafe \
            -Dtarget=${{ matrix.target.triplet }} \
            -Dcpu=${{ matrix.target.cpu }} \
            --summary all
          mv ./zig-out/bin/indexer ./indexer-${{ matrix.target.name }}
          mv ./zig-out/bin/ultar_httpd ./ultar_httpd-${{ matrix.target.name }}

      - name: Test
        run: |
          zig build test --summary all

      - name: Upload binaries to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./indexer-${{ matrix.target.name }}
            ./ultar_httpd-${{ matrix.target.name }}

  # Build Python wheels (ABI3 stable ABI, Python 3.11+)
  python-wheels:
    name: Python wheel ${{ matrix.target.platform }}
    runs-on: ${{ matrix.target.runner }}
    container: ${{ matrix.target.container }}
    strategy:
      matrix:
        target:
          - { platform: manylinux_2_28_x86_64, runner: ubuntu-22.04, container: "quay.io/pypa/manylinux_2_28_x86_64", cpu: x86_64_v3 }
          - { platform: manylinux_2_34_aarch64, runner: ubuntu-24.04-arm, container: "quay.io/pypa/manylinux_2_34_aarch64", cpu: neoverse_v2 }
          - { platform: macosx_11_0_arm64, runner: macos-latest, container: "", cpu: apple_m1 }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git describe --exact-match
          fetch-tags: true

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Setup Python (macOS)
        if: matrix.target.container == ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build dependencies (manylinux)
        if: matrix.target.container != ''
        run: |
          # Use Python 3.11 from manylinux's /opt/python
          export PATH="/opt/python/cp311-cp311/bin:$PATH"
          python3 -m pip install --upgrade pip
          python3 -m pip install build wheel setuptools
          # Verify Python is working
          python3 --version
          which python3

      - name: Install Python build dependencies (macOS)
        if: matrix.target.container == ''
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools

      - name: Build native extension (manylinux)
        if: matrix.target.container != ''
        run: |
          export PATH="/opt/python/cp311-cp311/bin:$PATH"
          zig build python-bindings \
            -Doptimize=ReleaseSafe \
            -Dcpu=${{ matrix.target.cpu }} \
            --summary all
        env:
          PYTHON: /opt/python/cp311-cp311/bin/python3

      - name: Build native extension (macOS)
        if: matrix.target.container == ''
        run: |
          zig build python-bindings \
            -Doptimize=ReleaseSafe \
            -Dcpu=${{ matrix.target.cpu }} \
            -Dlua=lua54 \
            --summary all
        env:
          PYTHON: python

      - name: Build wheel (manylinux)
        if: matrix.target.container != ''
        run: |
          export PATH="/opt/python/cp311-cp311/bin:$PATH"
          python3 -m build --wheel --no-isolation python/

      - name: Build wheel (macOS)
        if: matrix.target.container == ''
        run: |
          python -m build --wheel --no-isolation python/

      - name: Rename wheel to target platform
        run: |
          cd python/dist
          for whl in *.whl; do
            # Replace the platform tag with the target platform
            newname=$(echo "$whl" | sed -E "s/-(cp[0-9]+|py3)-abi3-[^.]+\.whl/-cp311-abi3-${{ matrix.target.platform }}.whl/")
            if [ "$whl" != "$newname" ]; then
              mv "$whl" "$newname"
            fi
          done
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.target.platform }}
          path: python/dist/*.whl

      - name: Upload wheel to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: python/dist/*.whl
