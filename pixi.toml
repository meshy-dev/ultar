[project]
name = "ultar"
version = "0.0.1"
description = "Fast async dataloader implemented in Zig with Lua scripting"
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64", "osx-arm64"]

[dependencies]
python = ">=3.11"
pip = "*"
zig = ">=0.15.1"

[pypi-dependencies]
setuptools = ">=61"
wheel = "*"
build = "*"

[tasks]
# Build the native Python extension using zig build
build-native = "zig build python-bindings -Doptimize=ReleaseFast"

# Build just the C shared library (for C/C++ users)
build-lib = "zig build -Doptimize=ReleaseFast"

# Build the Python wheel (copies pre-built .so into wheel)
build-wheel = { cmd = "python -m build --wheel --no-isolation python/", depends-on = ["build-native"] }

# Install the package in development mode (editable install)
dev-install = { cmd = "python -m pip install --no-build-isolation -e python/", depends-on = ["build-native"] }

# Run tests
test = { cmd = "python -m pytest python/tests/", depends-on = ["dev-install"] }

# Clean build artifacts
clean = "rm -rf python/build python/dist python/src/*.egg-info zig-out .zig-cache"

# Build everything (native + wheel)
build = { depends-on = ["build-wheel"] }

[feature.dev.pypi-dependencies]
pytest = ">=7.0"

[feature.torch.pypi-dependencies]
torch = ">=2.0"

# Python 3.11 for ABI3 compatibility testing
[feature.py311.dependencies]
python = "3.11.*"

[environments]
default = { features = [], solve-group = "default" }
dev = { features = ["dev"], solve-group = "default" }
torch = { features = ["dev", "torch"], solve-group = "default" }
# Test environment with Python 3.11 to verify ABI3 compatibility
test-py311 = { features = ["dev", "py311"], solve-group = "py311" }
